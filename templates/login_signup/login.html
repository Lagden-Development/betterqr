{% extends "login_signup/template.html" %} {% block title %}Login{% endblock %}
{% block content %}
<h2 class="text-3xl font-bold text-center mb-6">Login</h2>
<form id="login-form" method="post">
  {{ form.hidden_tag() }}
  <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response" />
  <div class="mb-4">
    <label
      class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2"
      for="email"
    >
      {{ form.email.label }}
    </label>
    {{ form.email(class_="shadow appearance-none border rounded w-full py-2 px-3
    text-gray-700 dark:text-white leading-tight focus:outline-none
    focus:shadow-outline", id="email", placeholder="Enter your email") }}
  </div>
  <div class="mb-6">
    <label
      class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2"
      for="password"
    >
      {{ form.password.label }}
    </label>
    {{ form.password(class_="shadow appearance-none border rounded w-full py-2
    px-3 text-gray-700 dark:text-white mb-3 leading-tight focus:outline-none
    focus:shadow-outline", id="password", placeholder="Enter your password") }}
  </div>
  <div class="flex items-center justify-between">
    <button
      class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
      type="submit"
    >
      Login
    </button>
  </div>
  <p class="mt-6 text-center text-gray-600 dark:text-gray-400 text-sm">
    Don't have an account?
    <a
      href="/signup?utm_source=internal&utm_medium=redirect&utm_campaign=signup_redirect&utm_content=dont_have_account"
      class="text-blue-500 hover:text-blue-700"
      >Sign up</a
    >
  </p>
  <p
    class="mt-4 text-center text-gray-600 dark:text-gray-400 text-xs google_msg"
  >
    This site is protected by reCAPTCHA and the Google
    <a href="https://policies.google.com/privacy" target="_blank"
      >Privacy Policy</a
    >
    and
    <a href="https://policies.google.com/terms" target="_blank"
      >Terms of Service</a
    >
    apply.
  </p>
</form>
{% endblock %} {% block formscript %}
<script>
  grecaptcha.ready(function () {
    function executeRecaptcha() {
      grecaptcha
        .execute("{{ recaptcha_site_key }}", { action: "login" })
        .then(function (token) {
          document.getElementById("g-recaptcha-response").value = token;
        });
    }

    $(document).ready(function () {
      $("#login-form").submit(function (event) {
        executeRecaptcha(); // Execute reCAPTCHA and submit the form
      });

      $("#login-form").ajaxForm({
        url: "/api/forms/login",
        type: "post",
        dataType: "json",
        success: function (response) {
          toastr.success(response.message);
          // Redirect to the app
          window.location.href =
            "/app?utm_source=internal&utm_medium=redirect&utm_campaign=login_redirect&utm_content=login_success";
        },
        error: function (xhr) {
          const errors = xhr.responseJSON.errors;
          if (errors.email) {
            console.error("Email error: ", errors.email);
            toastr.error(errors.email[0]);
          } else if (errors.password) {
            console.error("Password error: ", errors.password);
            toastr.error(errors.password[0]);
          } else if (errors.recaptcha) {
            toastr.error(errors.recaptcha[0]);
          } else if (errors.internal) {
            console.error("Internal error: ", errors.internal);
            toastr.error("Internal error. Please try again later.");
          } else {
            console.error("Unknown error: ", errors);
            toastr.error("Unknown error. Please try again later.");
          }
        },
      });
    });

    // Execute reCAPTCHA on load
    executeRecaptcha();
  });

  $(document).ready(function () {
    // Check if the "email" is in the URL Params, if so, populate the email field
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get("email");
    if (email) {
      $("#email").val(email);
    }

    // Check if "signup" = 1 in the URL Params, if so, show a success message using toastr
    if (urlParams.get("signup") === "1") {
      toastr.success("Signup successful. Please login with your credentials.");
    }
  });
</script>

{% endblock %}
